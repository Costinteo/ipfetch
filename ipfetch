#!/usr/bin/env bash

tempfile=`mktemp -u /tmp/ipfetch.XXXXXX`

if [ "$1" == "-ip" ] >/dev/null 2>&1 ; then
	wget https://ip.seeip.org/geoip/$2 -O "$tempfile" >/dev/null 2>&1 || exit 1
fi

# If no arguments were passed it will default to your own ip
[ $# -eq 0 ] >/dev/null 2>&1 && wget https://ip.seeip.org/geoip/ -O "$tempfile" >/dev/null 2>&1

# Replacing spaces with underscores
sed -i 's/ /_/g' "$tempfile"
sed -i 's/\\//g' "$tempfile"

# Uses grep to extract json data
ip=`sed -nr 's/.+"ip":"([0-9\.]+).+/\1/p' "$tempfile"`
continent=`sed -nr 's/.+"continent_code":"([^"]*).+/\1/p' "$tempfile"`
city=`sed -nr 's/.+"city":"([^"]*).+/\1/p' "$tempfile"`
isp=`sed -nr 's/.+"organization":"([^"]*).+/\1/p' "$tempfile"`
country=`sed -nr 's/.+"country":"([^"]*).+/\1/p' "$tempfile"`
timezone=`sed -nr 's/.+"timezone":"([^"]*).+/\1/p' "$tempfile"`
latitude=`sed -nr 's/.+"latitude":([^,]*).+/\1/p' "$tempfile"`
longitude=`sed -nr 's/.+"longitude":([^,]*).+/\1/p' "$tempfile"`
asn=`sed -nr 's/.+"asn":([^,]*).+/\1/p' "$tempfile"`
region=`sed -nr 's/.+"region":"([^"]*).+/\1/p' "$tempfile"`

rm "$tempfile"

# All of those \033 you see are cursor positions. Here is a good tutorial for it: https://thoughtsordiscoveries.wordpress.com/2017/04/26/set-and-read-cursor-position-in-terminal-windows-and-linux/
echo -e "\n`cat ~/.local/share/ipfetch/$country`\\033[s \033[9A Ip: $ip\
	\033[u\033[8A  Continent: $continent\033\
	[u\033[7A  Country: $country\
	\033[u\033[6A  Region: $region\
	\033[u\033[5A  City: $city\
	\033[u\033[4A  ISP: $isp\
	\033[u\033[3A  Timezone: $timezone\
	\033[u\033[2A  Latitude: $latitude\
	\033[u\033[1A  Longitude: $longitude
	\033[u  ASN: $asn\
	\033[u \033[10A -------------------- \033[u \n"

